@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix skos: <http://www.w3.org/2004/02/skos/core#> .
@prefix prov: <http://www.w3.org/ns/prov#> .
@prefix xch: <https://w3id.org/xch-mind/ontology/> .
@prefix xch-sh: <https://w3id.org/xch-mind/shapes/> .

# =============================================================================
# SHACL Shapes for xch-MIND Ontology
# =============================================================================
#
# Validates RDF graphs produced by xch-MIND against the xch-core.ttl ontology.
# These shapes enforce cardinality, datatype, and structural constraints that
# go beyond syntactic validation.
#
# Version: 0.1.0 (aligned with xch-core.ttl 0.1.0)
# =============================================================================


# =============================================================================
# SHAPE: InterpretiveAssertion (base provenance constraints)
# =============================================================================

xch-sh:InterpretiveAssertionShape
    a sh:NodeShape ;
    sh:targetClass xch:InterpretiveAssertion ;
    rdfs:label "Interpretive Assertion Shape"@en ;
    rdfs:comment "Base provenance constraints for all interpretive assertions."@en ;

    # Must have a confidence score between 0 and 1
    sh:property [
        sh:path xch:confidenceScore ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:decimal ;
        sh:minInclusive 0.0 ;
        sh:maxInclusive 1.0 ;
        sh:name "confidence score"@en ;
        sh:message "InterpretiveAssertion must have exactly one xch:confidenceScore in [0.0, 1.0]."@en ;
    ] ;

    # Must have a generation timestamp
    sh:property [
        sh:path xch:generatedAt ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:dateTime ;
        sh:name "generated at"@en ;
        sh:message "InterpretiveAssertion must have exactly one xch:generatedAt timestamp."@en ;
    ] ;

    # Must have a validation status
    sh:property [
        sh:path xch:hasValidationStatus ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:nodeKind sh:IRI ;
        sh:name "validation status"@en ;
        sh:message "InterpretiveAssertion must have exactly one xch:hasValidationStatus."@en ;
    ] ;

    # Must have a label
    sh:property [
        sh:path rdfs:label ;
        sh:minCount 1 ;
        sh:name "label"@en ;
        sh:message "InterpretiveAssertion must have at least one rdfs:label."@en ;
    ] ;

    # generatedBy must be an IRI (agent URI, not a literal)
    sh:property [
        sh:path xch:generatedBy ;
        sh:minCount 1 ;
        sh:nodeKind sh:IRI ;
        sh:name "generated by"@en ;
        sh:message "InterpretiveAssertion must have xch:generatedBy pointing to an agent IRI."@en ;
    ] ;

    # groundedOn must point to IRIs (source ArCo entities)
    sh:property [
        sh:path xch:groundedOn ;
        sh:nodeKind sh:IRI ;
        sh:name "grounded on"@en ;
        sh:message "xch:groundedOn must point to IRI resources."@en ;
    ] .


# =============================================================================
# SHAPE: GeographicCluster
# =============================================================================

xch-sh:GeographicClusterShape
    a sh:NodeShape ;
    sh:targetClass xch:GeographicCluster ;
    rdfs:label "Geographic Cluster Shape"@en ;

    # Must have at least 2 member sites
    sh:property [
        sh:path xch:includesSite ;
        sh:minCount 2 ;
        sh:nodeKind sh:IRI ;
        sh:name "cluster members"@en ;
        sh:message "GeographicCluster must include at least 2 sites."@en ;
    ] ;

    # regionName is optional but must be a string if present
    sh:property [
        sh:path xch:regionName ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:name "region name"@en ;
    ] .


# =============================================================================
# SHAPE: ChronologicalCluster
# =============================================================================

xch-sh:ChronologicalClusterShape
    a sh:NodeShape ;
    sh:targetClass xch:ChronologicalCluster ;
    rdfs:label "Chronological Cluster Shape"@en ;

    # Must have at least 2 member sites
    sh:property [
        sh:path xch:includesSite ;
        sh:minCount 2 ;
        sh:nodeKind sh:IRI ;
        sh:name "cluster members"@en ;
        sh:message "ChronologicalCluster must include at least 2 sites."@en ;
    ] ;

    # Must have a period label
    sh:property [
        sh:path xch:periodLabel ;
        sh:minCount 1 ;
        sh:datatype xsd:string ;
        sh:name "period label"@en ;
        sh:message "ChronologicalCluster must have at least one xch:periodLabel."@en ;
    ] ;

    # startYear/endYear must be integers if present
    sh:property [
        sh:path xch:startYear ;
        sh:maxCount 1 ;
        sh:datatype xsd:integer ;
        sh:name "start year"@en ;
    ] ;

    sh:property [
        sh:path xch:endYear ;
        sh:maxCount 1 ;
        sh:datatype xsd:integer ;
        sh:name "end year"@en ;
    ] .


# =============================================================================
# SHAPE: TypologicalCluster
# =============================================================================

xch-sh:TypologicalClusterShape
    a sh:NodeShape ;
    sh:targetClass xch:TypologicalCluster ;
    rdfs:label "Typological Cluster Shape"@en ;

    # Must have at least 2 member sites
    sh:property [
        sh:path xch:includesSite ;
        sh:minCount 2 ;
        sh:nodeKind sh:IRI ;
        sh:name "cluster members"@en ;
        sh:message "TypologicalCluster must include at least 2 sites."@en ;
    ] ;

    # Must have a typology label
    sh:property [
        sh:path xch:typologyLabel ;
        sh:minCount 1 ;
        sh:datatype xsd:string ;
        sh:name "typology label"@en ;
        sh:message "TypologicalCluster must have at least one xch:typologyLabel."@en ;
    ] .


# =============================================================================
# SHAPE: SpatialRelation
# =============================================================================

xch-sh:SpatialRelationShape
    a sh:NodeShape ;
    sh:targetClass xch:SpatialRelation ;
    rdfs:label "Spatial Relation Shape"@en ;

    # Must have exactly one source and one target
    sh:property [
        sh:path xch:source ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:nodeKind sh:IRI ;
        sh:name "source"@en ;
        sh:message "SpatialRelation must have exactly one xch:source."@en ;
    ] ;

    sh:property [
        sh:path xch:target ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:nodeKind sh:IRI ;
        sh:name "target"@en ;
        sh:message "SpatialRelation must have exactly one xch:target."@en ;
    ] ;

    # distanceKm must be a non-negative decimal if present
    sh:property [
        sh:path xch:distanceKm ;
        sh:maxCount 1 ;
        sh:datatype xsd:decimal ;
        sh:minInclusive 0.0 ;
        sh:name "distance km"@en ;
        sh:message "xch:distanceKm must be a non-negative decimal."@en ;
    ] .


# =============================================================================
# SHAPE: TypologicalRelation
# =============================================================================

xch-sh:TypologicalRelationShape
    a sh:NodeShape ;
    sh:targetClass xch:TypologicalRelation ;
    rdfs:label "Typological Relation Shape"@en ;

    sh:property [
        sh:path xch:source ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:nodeKind sh:IRI ;
        sh:name "source"@en ;
        sh:message "TypologicalRelation must have exactly one xch:source."@en ;
    ] ;

    sh:property [
        sh:path xch:target ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:nodeKind sh:IRI ;
        sh:name "target"@en ;
        sh:message "TypologicalRelation must have exactly one xch:target."@en ;
    ] ;

    # similarityScore between 0 and 1 if present
    sh:property [
        sh:path xch:similarityScore ;
        sh:maxCount 1 ;
        sh:datatype xsd:decimal ;
        sh:minInclusive 0.0 ;
        sh:maxInclusive 1.0 ;
        sh:name "similarity score"@en ;
        sh:message "xch:similarityScore must be a decimal in [0.0, 1.0]."@en ;
    ] .


# =============================================================================
# SHAPE: TemporalRelation
# =============================================================================

xch-sh:TemporalRelationShape
    a sh:NodeShape ;
    sh:targetClass xch:TemporalRelation ;
    rdfs:label "Temporal Relation Shape"@en ;

    sh:property [
        sh:path xch:source ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:nodeKind sh:IRI ;
        sh:name "source"@en ;
        sh:message "TemporalRelation must have exactly one xch:source."@en ;
    ] ;

    sh:property [
        sh:path xch:target ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:nodeKind sh:IRI ;
        sh:name "target"@en ;
        sh:message "TemporalRelation must have exactly one xch:target."@en ;
    ] .


# =============================================================================
# SHAPE: ThematicPath (and subclasses)
# =============================================================================

xch-sh:ThematicPathShape
    a sh:NodeShape ;
    sh:targetClass xch:ThematicPath ;
    rdfs:label "Thematic Path Shape"@en ;

    # Must have at least 2 stops (a path with 1 stop is not a path)
    sh:property [
        sh:path xch:hasStop ;
        sh:minCount 2 ;
        sh:nodeKind sh:IRI ;
        sh:name "path stops"@en ;
        sh:message "ThematicPath must have at least 2 stops."@en ;
    ] ;

    # pathLength must be a positive integer if present
    sh:property [
        sh:path xch:pathLength ;
        sh:maxCount 1 ;
        sh:datatype xsd:integer ;
        sh:minInclusive 2 ;
        sh:name "path length"@en ;
        sh:message "xch:pathLength must be >= 2."@en ;
    ] ;

    # estimatedDuration must be xsd:duration if present
    sh:property [
        sh:path xch:estimatedDuration ;
        sh:maxCount 1 ;
        sh:datatype xsd:duration ;
        sh:name "estimated duration"@en ;
        sh:message "xch:estimatedDuration must be an xsd:duration value."@en ;
    ] ;

    # difficulty must be a string if present
    sh:property [
        sh:path xch:difficulty ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:name "difficulty"@en ;
    ] ;

    # hasTheme must point to an IRI (skos:Concept)
    sh:property [
        sh:path xch:hasTheme ;
        sh:nodeKind sh:IRI ;
        sh:name "theme"@en ;
        sh:message "xch:hasTheme must point to an IRI (skos:Concept)."@en ;
    ] .


# =============================================================================
# SHAPE: PathStop
# =============================================================================

xch-sh:PathStopShape
    a sh:NodeShape ;
    sh:targetClass xch:PathStop ;
    rdfs:label "Path Stop Shape"@en ;

    # Must have a stop order (positive integer)
    sh:property [
        sh:path xch:stopOrder ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:integer ;
        sh:minInclusive 1 ;
        sh:name "stop order"@en ;
        sh:message "PathStop must have exactly one xch:stopOrder >= 1."@en ;
    ] ;

    # Must belong to a path
    sh:property [
        sh:path xch:belongsToPath ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:nodeKind sh:IRI ;
        sh:name "belongs to path"@en ;
        sh:message "PathStop must belong to exactly one path via xch:belongsToPath."@en ;
    ] ;

    # stopSite must be an IRI if present
    sh:property [
        sh:path xch:stopSite ;
        sh:nodeKind sh:IRI ;
        sh:name "stop site"@en ;
        sh:message "xch:stopSite must point to an IRI."@en ;
    ] .


# =============================================================================
# SHAPE: ExtractedFeature
# =============================================================================

xch-sh:ExtractedFeatureShape
    a sh:NodeShape ;
    sh:targetClass xch:ExtractedFeature ;
    rdfs:label "Extracted Feature Shape"@en ;

    # Must have a feature label
    sh:property [
        sh:path xch:featureLabel ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:name "feature label"@en ;
        sh:message "ExtractedFeature must have exactly one xch:featureLabel."@en ;
    ] ;

    # featureOf must point to an IRI
    sh:property [
        sh:path xch:featureOf ;
        sh:minCount 1 ;
        sh:nodeKind sh:IRI ;
        sh:name "feature of"@en ;
        sh:message "ExtractedFeature must have at least one xch:featureOf linking to an entity."@en ;
    ] .
